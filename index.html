<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="format-detection" content="telephone=no">
<title>Reserva de Carrito</title>

<!-- Perf para reCAPTCHA -->
<link rel="preconnect" href="https://www.google.com">
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>

<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --border:#e5e7eb; --text:#111827; --muted:#6b7280;
    --primary:#2563eb; --danger:#dc2626; --ok:#16a34a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    font-size:16px;
  }
  @media (max-width:480px){ body{font-size:18px} }

  .wrap{max-width:920px;margin:0 auto;padding:clamp(12px,3.2vw,28px)}
  .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:clamp(14px,3.5vw,28px);box-shadow:0 6px 24px rgba(0,0,0,.06)}

  h2{margin:0 0 .5rem;font-size:clamp(1.25rem,4.8vw,1.8rem)}
  p.lead{margin:.25rem 0 1rem;color:var(--muted);font-size:clamp(1rem,3.8vw,1.05rem)}

  form{display:grid;gap:clamp(10px,3vw,18px)}
  label{font-weight:600;font-size:clamp(1rem,3.9vw,1.06rem);margin-bottom:6px;display:block}
  input,button{
    width:100%;padding:clamp(12px,3.4vw,14px);
    border:1px solid var(--border);border-radius:12px;font-size:clamp(1rem,3.8vw,1.06rem);
    background:#fff;
  }
  input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  .row{display:grid;gap:clamp(8px,2.8vw,12px)}
  .two{grid-template-columns:1fr 1fr;gap:clamp(8px,2.8vw,14px)}
  @media (max-width:760px){.two{grid-template-columns:1fr}}

  .sigRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .sigBtn{width:auto;background:var(--primary);color:#fff;border:none;font-weight:600;border-radius:10px;padding:10px 14px;cursor:pointer}
  .sigClear{width:auto;background:#fff;color:#111827;border:1px solid var(--border);border-radius:10px;padding:10px 14px}
  .thumb{width:160px;max-width:45vw;height:72px;border:1px solid var(--border);border-radius:8px;object-fit:contain;background:#fff;display:none}

  .btn{background:var(--primary);color:#fff;border:none;font-weight:600;cursor:pointer;display:inline-flex;gap:8px;align-items:center;justify-content:center}
  .btn[disabled]{opacity:.7;cursor:not-allowed}
  .spinner{width:1.1em;height:1.1em;border:2px solid rgba(255,255,255,.5);border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  .captchaBox{display:flex;justify-content:center}
  .footNote{color:var(--muted);font-size:.95rem;margin-top:.25rem}

  /* Modal mensajes */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);padding:16px;z-index:10000}
  .modal.show{display:flex}
  .modal .box{width:min(92vw,520px);background:#fff;border-radius:14px;padding:18px;border:1px solid var(--border);text-align:center}
  .modal h3{margin:.2rem 0 .6rem;font-size:1.15rem}
  .modal p{color:var(--text);margin:.2rem 0 1rem}
  .modal .btn{min-width:160px}
  .modal .error{color:var(--danger)}
  .modal .ok{color:var(--ok)}

  /* Modal de firma full-screen */
  .sigModal{position:fixed;inset:0;background:#0f172a;display:none;flex-direction:column;z-index:11000}
  .sigModal.show{display:flex}
  .sigTop{color:#fff;display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.1)}
  .sigTopTitle{font-weight:700}
  .sigTop .btn, .sigTop .sigClear{padding:8px 12px;border-radius:10px}
  .sigCanvasFS{flex:1;background:#fff;touch-action:none}
  .bar{display:flex;gap:8px}

  /* Barra idiomas */
  .langbar button.flag{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
</style>

<!-- Resolver idioma antes de cargar reCAPTCHA y setear <html lang> -->
<script>
  (function(){
    const qs = new URLSearchParams(location.search);
    let lang = qs.get('lang') || localStorage.getItem('lang') || (navigator.language||'').slice(0,2);
    if (!['es','en','pt'].includes(lang)) lang = 'en';
    localStorage.setItem('lang', lang);
    window.APP_LANG = lang;
    document.documentElement.setAttribute('lang', lang);

    // Inyectar reCAPTCHA una sola vez por carga con el idioma elegido
    const s = document.createElement('script');
    s.id = 'grecap-script';
    s.src = 'https://www.google.com/recaptcha/api.js?onload=recaptchaOnload&render=explicit&hl=' + encodeURIComponent(lang);
    s.async = true; s.defer = true;
    document.head.appendChild(s);
  })();
</script>
</head>
<body>
  <div class="wrap">
    <div class="card">

      <!-- ===== Barra de idiomas (recarga con ?lang=xx) ===== -->
      <div class="langbar" style="display:flex;gap:10px;justify-content:flex-end;margin-bottom:8px">
        <button class="flag" data-lang="es" title="Español" aria-label="Español">Español</button>
        <button class="flag" data-lang="en" title="English" aria-label="English">English</button>
        <button class="flag" data-lang="pt" title="Português" aria-label="Português">Português</button>
      </div>

      <h2>Reserva de Carrito</h2>
      <p class="lead">Completá los datos y capturá la firma en pantalla completa.</p>

      <form id="f" autocomplete="off">
        <input name="empresa" autocomplete="off" style="position:absolute;left:-9999px;top:-9999px" tabindex="-1">
        <input type="hidden" name="t0" id="t0">
        <!-- donde guardamos los PNG en base64 -->
        <input type="hidden" name="firmaClienteDataURL" id="firmaClienteDataURL">
        <input type="hidden" name="firmaStaffDataURL"   id="firmaStaffDataURL">

        <div class="row"><label>Cliente/Visitante</label><input name="cliente" required placeholder="Nombre y apellido" inputmode="text"></div>

        <div class="row two">
          <div><label>DNI / Pasaporte</label><input name="dni" required inputmode="text"></div>
          <div><label>Teléfono de contacto</label><input name="telefono" required inputmode="tel" placeholder="+54 9 ..."></div>
        </div>

        <div class="row"><label>Domicilio</label><input name="domicilio" inputmode="text"></div>

        <div class="row two">
          <div><label>Fecha</label><input name="fecha" type="date" required></div>
          <div><label>Hora</label><input name="hora" type="time" step="60" required></div>
        </div>

        <div class="row"><label>Email del cliente (para enviar confirmación)</label><input name="emailCliente" type="email" placeholder="opcional" inputmode="email"></div>

        <!-- Firma Cliente -->
        <div class="row">
          <label>Firma del Cliente/Visitante</label>
          <div class="sigRow">
            <button type="button" class="sigBtn" id="openSigCliente">✍️ Firmar</button>
            <button type="button" class="sigClear" id="clearSigCliente">Borrar</button>
            <img id="thumbCliente" class="thumb" alt="Vista previa firma cliente">
          </div>
        </div>

        <!-- Datos Staff -->
        <div class="row">
          <label>Nombre y apellido del personal de Iguazú Argentina S.A.</label>
          <input name="staff" placeholder="opcional">
        </div>

        <!-- Firma Staff -->
        <div class="row">
          <label>Firma del personal de Iguazú Argentina S.A. (opcional)</label>
          <div class="sigRow">
            <button type="button" class="sigBtn" id="openSigStaff">✍️ Firmar</button>
            <button type="button" class="sigClear" id="clearSigStaff">Borrar</button>
            <img id="thumbStaff" class="thumb" alt="Vista previa firma staff">
          </div>
        </div>

        <!-- reCAPTCHA (render explícito) -->
        <div class="captchaBox">
          <div id="recaptcha"></div>
        </div>

        <button id="submitBtn" class="btn" type="submit" style="padding:12px 18px;border-radius:12px">
          <span class="btnText">Enviar</span>
          <span class="spinner" style="display:none"></span>
        </button>
        <div class="footNote">Al enviar, aceptás el uso de tus datos para gestionar la reserva.</div>
      </form>
    </div>
  </div>

  <!-- Modal de firma (reutilizable para cliente/staff) -->
  <div id="sigModal" class="sigModal" aria-modal="true" role="dialog">
    <div class="sigTop">
      <div class="sigTopTitle" id="sigTitle">Firmar</div>
      <div class="bar">
        <button type="button" class="sigClear" id="sigClearBtn">Borrar</button>
        <button type="button" class="sigClear" id="sigCancelBtn">Cancelar</button>
        <button type="button" class="btn" id="sigUseBtn">Usar firma</button>
      </div>
    </div>
    <canvas id="sigCanvasFS" class="sigCanvasFS"></canvas>
  </div>

  <!-- Modal éxito / error -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="box">
      <h3 id="modalTitle">Mensaje</h3>
      <p id="modalMsg"></p>
      <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
        <button id="modalOk" class="btn" type="button">OK</button>
        <button id="modalRetry" class="sigClear" type="button" style="display:none">Reintentar</button>
      </div>
    </div>
  </div>

<!-- ===== LÓGICA PRINCIPAL ===== -->
<script>
  /* ===== CONFIG ===== */
  const APPS_URL = 'https://script.google.com/macros/s/AKfycbwSlAExsi5mF3Zgr-N3nB9QcrAaW8TktcSr-ZhOaoXGEfo8l6SsW5K8fQ5Wqp3Yhuv2/exec';
  document.getElementById('t0').value = Date.now();

  /* === Fecha y hora por defecto (zona local del dispositivo) === */
  (function setDefaultDateTime(){
    const fFecha = document.querySelector('input[name="fecha"]');
    const fHora  = document.querySelector('input[name="hora"]');
    if (!fFecha || !fHora) return;

    const now    = new Date();
    const tzMs   = now.getTimezoneOffset() * 60000;
    const local  = new Date(Date.now() - tzMs);

    const yyyyMmDd = local.toISOString().slice(0, 10);
    const hhMm     = local.toISOString().slice(11, 16);

    if (!fFecha.value) fFecha.value = yyyyMmDd;
    if (!fHora.value)  fHora.value  = hhMm;

    // Evitar fechas anteriores a hoy
    fFecha.min = yyyyMmDd;
  })();

  /* ===== MODAL MENSAJES ===== */
  const modal=document.getElementById('modal'),modalTitle=document.getElementById('modalTitle'),modalMsg=document.getElementById('modalMsg'),modalOk=document.getElementById('modalOk'),modalRetry=document.getElementById('modalRetry');
  function showModal({title,msg,isError=false,onOk=null,showRetry=false,onRetry=null}){modalTitle.textContent=title||(isError?'Error':'Información');modalMsg.innerHTML=msg||'';modal.classList.add('show');modalMsg.classList.toggle('error',isError);modalMsg.classList.toggle('ok',!isError);modalRetry.style.display=showRetry?'inline-block':'none';modalOk.onclick=()=>{modal.classList.remove('show');onOk&&onOk();};modalRetry.onclick=()=>{modal.classList.remove('show');onRetry&&onRetry();};}

  /* ===== MODAL FIRMA FULL-SCREEN ===== */
  const sigModal = document.getElementById('sigModal');
  const sigCanvas = document.getElementById('sigCanvasFS');
  const sigTitle  = document.getElementById('sigTitle');
  const sigClearBtn  = document.getElementById('sigClearBtn');
  const sigCancelBtn = document.getElementById('sigCancelBtn');
  const sigUseBtn    = document.getElementById('sigUseBtn');

  let currentTarget = null; // 'cliente' | 'staff'

  // Abrir/cerrar/limpiar
  document.getElementById('openSigCliente').onclick = ()=> openSig('cliente');
  document.getElementById('openSigStaff').onclick   = ()=> openSig('staff');
  document.getElementById('clearSigCliente').onclick = ()=> clearSaved('cliente');
  document.getElementById('clearSigStaff').onclick   = ()=> clearSaved('staff');

  function openSig(which){
    currentTarget = which;
    setSigModalTitle(which); // i18n
    sigModal.classList.add('show');
    resetSigCanvas(); // limpia y ajusta tamaño
  }
  function closeSig(){ sigModal.classList.remove('show'); }
  function clearSaved(which){
    const input = document.getElementById(which==='cliente' ? 'firmaClienteDataURL' : 'firmaStaffDataURL');
    const thumb = document.getElementById(which==='cliente' ? 'thumbCliente' : 'thumbStaff');
    input.value = ''; thumb.style.display = 'none'; thumb.src = '';
  }

  // Canvas de firma FS (retina + dibujo)
  const ctx = sigCanvas.getContext('2d');
  function resetSigCanvas(){
    const ratio = Math.max(window.devicePixelRatio||1,1);
    const dw = window.innerWidth;
    const dh = window.innerHeight - 56; // resta barra superior
    sigCanvas.style.width = dw + 'px';
    sigCanvas.style.height= dh + 'px';
    sigCanvas.width  = Math.floor(dw*ratio);
    sigCanvas.height = Math.floor(dh*ratio);
    ctx.setTransform(ratio,0,0,ratio,0,0);
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,sigCanvas.width, sigCanvas.height);
    ctx.lineWidth = 2.8; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#111';
  }
  window.addEventListener('resize', ()=>{ if(sigModal.classList.contains('show')) resetSigCanvas(); });

  let drawing=false,last=null;
  function pos(e){const r=sigCanvas.getBoundingClientRect();const t=e.touches?e.touches[0]:e;return {x:t.clientX-r.left,y:t.clientY-r.top};}
  function start(e){drawing=true;last=pos(e);e.preventDefault();}
  function move(e){if(!drawing)return;const p=pos(e);ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p;e.preventDefault();}
  function end(){drawing=false;last=null;}

  sigCanvas.addEventListener('mousedown',start);
  sigCanvas.addEventListener('mousemove',move);
  sigCanvas.addEventListener('mouseup',end);
  sigCanvas.addEventListener('mouseleave',end);
  sigCanvas.addEventListener('touchstart',start,{passive:false});
  sigCanvas.addEventListener('touchmove',move,{passive:false});
  sigCanvas.addEventListener('touchend',end);

  sigClearBtn.onclick = ()=> ctx.clearRect(0,0,sigCanvas.width,sigCanvas.height), resetSigCanvas();
  sigCancelBtn.onclick= ()=> closeSig();
  sigUseBtn.onclick   = ()=> {
    const dataURL = sigCanvas.toDataURL('image/png');
    const input = document.getElementById(currentTarget==='cliente' ? 'firmaClienteDataURL' : 'firmaStaffDataURL');
    const thumb = document.getElementById(currentTarget==='cliente' ? 'thumbCliente' : 'thumbStaff');
    input.value = dataURL;
    thumb.src = dataURL;
    thumb.style.display = 'block';
    closeSig();
  };

  /* ===== ENVÍO ===== */
  const form=document.getElementById('f'),submitBtn=document.getElementById('submitBtn'),btnText=submitBtn.querySelector('.btnText'),spinner=submitBtn.querySelector('.spinner');
  function setSending(v){submitBtn.disabled=v;spinner.style.display=v?'inline-block':'none';btnText.textContent=v?t('btn_sending'):t('btn_send');}
  function isBlankDataURL(s){return !s || s.length < 50;} // heurística simple

  // reCAPTCHA: render explícito y helpers (definidos globales más abajo)
  let recaptchaWidgetId = null;
  window.recaptchaOnload = function(){
    recaptchaWidgetId = grecaptcha.render('recaptcha', { sitekey: RECAPTCHA_SITEKEY });
  };

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (submitBtn.disabled) return;

    const recaptchaToken = (window.grecaptcha && recaptchaWidgetId !== null)
      ? grecaptcha.getResponse(recaptchaWidgetId)
      : '';

    if (!recaptchaToken){ const m=i18nModal('recaptcha'); showModal({title:m.title, msg:m.msg}); return; }

    // Exigir firma de cliente
    if (isBlankDataURL(document.getElementById('firmaClienteDataURL').value)){
      const m=i18nModal('needSign'); showModal({title:m.title, msg:m.msg}); return;
    }

    const fd = new FormData(form);
    const payload = Object.fromEntries(fd.entries());
    payload.recaptchaToken = recaptchaToken;

    setSending(true);
    try{
      const res = await fetch(APPS_URL, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });
      const json = await res.json().catch(()=>({ok:false,error:'Respuesta inválida'}));
      setSending(false);
      if (window.grecaptcha && recaptchaWidgetId !== null) grecaptcha.reset(recaptchaWidgetId);

      if (json.ok){
        const m=i18nModal('sentOk');
        showModal({title:m.title, msg:m.msg, onOk: ()=>location.reload()});
      } else {
        const m=i18nModal('sentFail');
        showModal({title:m.title, msg:`<span class="error">${json.error||'Error desconocido'}</span>`, isError:true, showRetry:true, onRetry: ()=>form.dispatchEvent(new Event('submit',{cancelable:true}))});
      }
    } catch(err){
      setSending(false);
      if (window.grecaptcha && recaptchaWidgetId !== null) grecaptcha.reset(recaptchaWidgetId);
      const m=i18nModal('netErr');
      showModal({title:m.title, msg:`<span class="error">${String(err)}</span>`, isError:true, showRetry:true, onRetry: ()=>form.dispatchEvent(new Event('submit',{cancelable:true}))});
    }
  });
</script>

<!-- ===== i18n (ES/EN/PT) ===== -->
<script>
const I18N = {
  es: {
    title: "Reserva de Carrito",
    lead: "Completá los datos y capturá la firma en pantalla completa.",
    cliente_label: "Cliente/Visitante",
    cliente_ph: "Nombre y apellido",
    dni_label: "DNI / Pasaporte",
    tel_label: "Teléfono de contacto",
    tel_ph: "+54 9 ...",
    dom_label: "Domicilio",
    fecha_label: "Fecha",
    hora_label: "Hora",
    email_label: "Email del cliente (para enviar confirmación)",
    email_ph: "opcional",
    staff_label: "Nombre y apellido del personal de Iguazú Argentina S.A.",
    staff_ph: "opcional",
    firma_cli_label: "Firma del Cliente/Visitante",
    firma_staff_label: "Firma del personal de Iguazú Argentina S.A. (opcional)",
    sign_open: "✍️ Firmar",
    sign_clear: "Borrar",
    sign_use: "Usar firma",
    sign_cancel: "Cancelar",
    fs_title_cli: "Firma del Cliente/Visitante",
    fs_title_staff: "Firma del personal (opcional)",
    recaptcha_hint_title: "Falta verificación",
    recaptcha_hint_msg: "Marcá <b>No soy un robot</b>.",
    need_sign_title: "Falta firma",
    need_sign_msg: "Necesitamos la firma del cliente (botón ✍️ Firmar).",
    sent_ok_title: "¡Enviado correctamente!",
    sent_ok_msg: "Tu reserva fue registrada y se envió la confirmación por correo.",
    sent_fail_title: "No se pudo enviar",
    error_net_title: "Error de red",
    btn_send: "Enviar",
    btn_sending: "Enviando…",
    btn_ok: "OK",
    btn_retry: "Reintentar",
    footnote: "Al enviar, aceptás el uso de tus datos para gestionar la reserva."
  },
  en: {
    title: "Cart Reservation",
    lead: "Fill in the details and capture the signature in full screen.",
    cliente_label: "Customer/Visitor",
    cliente_ph: "Full name",
    dni_label: "ID / Passport",
    tel_label: "Contact phone",
    tel_ph: "+54 9 ...",
    dom_label: "Address",
    fecha_label: "Date",
    hora_label: "Time",
    email_label: "Customer email (to send confirmation)",
    email_ph: "optional",
    staff_label: "Full name of Iguazú Argentina S.A. staff",
    staff_ph: "optional",
    firma_cli_label: "Customer/Visitor Signature",
    firma_staff_label: "Staff Signature (optional)",
    sign_open: "✍️ Sign",
    sign_clear: "Clear",
    sign_use: "Use signature",
    sign_cancel: "Cancel",
    fs_title_cli: "Customer/Visitor Signature",
    fs_title_staff: "Staff Signature (optional)",
    recaptcha_hint_title: "Verification needed",
    recaptcha_hint_msg: "Please tick <b>I'm not a robot</b>.",
    need_sign_title: "Signature required",
    need_sign_msg: "We need the customer's signature (tap ✍️ Sign).",
    sent_ok_title: "Sent successfully!",
    sent_ok_msg: "Your reservation was registered and a confirmation email was sent.",
    sent_fail_title: "Couldn't send",
    error_net_title: "Network error",
    btn_send: "Send",
    btn_sending: "Sending…",
    btn_ok: "OK",
    btn_retry: "Retry",
    footnote: "By sending, you agree to the use of your data to manage the reservation."
  },
  pt: {
    title: "Reserva de Carrinho",
    lead: "Preencha os dados e capture a assinatura em tela cheia.",
    cliente_label: "Cliente/Visitante",
    cliente_ph: "Nome e sobrenome",
    dni_label: "RG / Passaporte",
    tel_label: "Telefone de contato",
    tel_ph: "+55 ...",
    dom_label: "Endereço",
    fecha_label: "Data",
    hora_label: "Hora",
    email_label: "E-mail do cliente (para enviar confirmação)",
    email_ph: "opcional",
    staff_label: "Nome completo do funcionário da Iguazú Argentina S.A.",
    staff_ph: "opcional",
    firma_cli_label: "Assinatura do Cliente/Visitante",
    firma_staff_label: "Assinatura do funcionário (opcional)",
    sign_open: "✍️ Assinar",
    sign_clear: "Apagar",
    sign_use: "Usar assinatura",
    sign_cancel: "Cancelar",
    fs_title_cli: "Assinatura do Cliente/Visitante",
    fs_title_staff: "Assinatura do funcionário (opcional)",
    recaptcha_hint_title: "Verificação necessária",
    recaptcha_hint_msg: "Marque <b>Não sou um robô</b>.",
    need_sign_title: "Falta assinatura",
    need_sign_msg: "Precisamos da assinatura do cliente (botão ✍️ Assinar).",
    sent_ok_title: "Enviado com sucesso!",
    sent_ok_msg: "Sua reserva foi registrada e um e-mail de confirmação foi enviado.",
    sent_fail_title: "Não foi possível enviar",
    error_net_title: "Erro de rede",
    btn_send: "Enviar",
    btn_sending: "Enviando…",
    btn_ok: "OK",
    btn_retry: "Tentar novamente",
    footnote: "Ao enviar, você concorda com o uso de seus dados para gerenciar a reserva."
  }
};

/* Idioma desde el pre-bootstrap del <head> */
const LANG = window.APP_LANG || 'es';
const RECAPTCHA_SITEKEY = '6LcHCfIrAAAAAHZ9i6z-7WfL6O6CrmKeBMhytK-r';

function t(key){ return (I18N[LANG] && I18N[LANG][key]) || I18N.es[key] || key; }

function applyI18n(){
  document.documentElement.lang = LANG;

  // Título y lead
  const h2 = document.querySelector('h2'); if (h2) h2.textContent = t('title');
  const lead = document.querySelector('.lead'); if (lead) lead.textContent = t('lead');

  // Helper para cambiar labels por input name
  const setLabelBefore = (name, text)=>{
    const input = document.querySelector(`[name="${name}"]`);
    if (input && input.previousElementSibling && input.previousElementSibling.tagName==='LABEL'){
      input.previousElementSibling.textContent = text;
    }
  };
  setLabelBefore('cliente', t('cliente_label'));
  setLabelBefore('dni',     t('dni_label'));
  setLabelBefore('telefono',t('tel_label'));
  setLabelBefore('domicilio',t('dom_label'));
  setLabelBefore('fecha',   t('fecha_label'));
  setLabelBefore('hora',    t('hora_label'));
  setLabelBefore('emailCliente', t('email_label'));
  setLabelBefore('staff',   t('staff_label'));

  // Placeholders
  const setPH = (name, text)=>{ const el = document.querySelector(`[name="${name}"]`); if (el) el.placeholder = text; };
  setPH('cliente', t('cliente_ph'));
  setPH('telefono', t('tel_ph'));
  setPH('emailCliente', t('email_ph'));
  setPH('staff', t('staff_ph'));

  // Firmas: labels cercanos a los botones
  const labelFirmaCli = document.getElementById('openSigCliente')?.closest('.row')?.previousElementSibling;
  if (labelFirmaCli && labelFirmaCli.tagName==='LABEL') labelFirmaCli.textContent = t('firma_cli_label');
  const labelFirmaStaff = document.getElementById('openSigStaff')?.closest('.row')?.previousElementSibling;
  if (labelFirmaStaff && labelFirmaStaff.tagName==='LABEL') labelFirmaStaff.textContent = t('firma_staff_label');

  // Botones de firma y limpieza
  const btnOpenCli = document.getElementById('openSigCliente');
  const btnOpenStf = document.getElementById('openSigStaff');
  const clearCli   = document.getElementById('clearSigCliente');
  const clearStf   = document.getElementById('clearSigStaff');
  if (btnOpenCli) btnOpenCli.textContent = t('sign_open');
  if (btnOpenStf) btnOpenStf.textContent = t('sign_open');
  if (clearCli)   clearCli.textContent   = t('sign_clear');
  if (clearStf)   clearStf.textContent   = t('sign_clear');

  // Modal firma FS + botones
  const sigClearBtn  = document.getElementById('sigClearBtn');
  const sigCancelBtn = document.getElementById('sigCancelBtn');
  const sigUseBtn    = document.getElementById('sigUseBtn');
  const sigTitle     = document.getElementById('sigTitle');
  if (sigClearBtn)  sigClearBtn.textContent  = t('sign_clear');
  if (sigCancelBtn) sigCancelBtn.textContent = t('sign_cancel');
  if (sigUseBtn)    sigUseBtn.textContent    = t('sign_use');
  if (sigTitle)     sigTitle.textContent     = t('fs_title_cli'); // por defecto

  // Botón submit + footnote
  const btnText = document.querySelector('#submitBtn .btnText'); if (btnText) btnText.textContent = t('btn_send');
  const foot = document.querySelector('.footNote'); if (foot) foot.textContent = t('footnote');

  // Botones del modal general
  const modalOk   = document.getElementById('modalOk');    if (modalOk)   modalOk.textContent   = t('btn_ok');
  const modalRetry= document.getElementById('modalRetry'); if (modalRetry)modalRetry.textContent= t('btn_retry');
}

// Banderas (recargar con ?lang=xx para evitar delays del reCAPTCHA)
document.querySelectorAll('.flag').forEach(b=>{
  b.addEventListener('click', ()=>{
    const lang = b.dataset.lang;
    const url = new URL(location.href);
    url.searchParams.set('lang', lang);
    localStorage.setItem('lang', lang);
    location.href = url.toString(); // recarga intencional
  });
});

// Ajustar textos al cargar
applyI18n();

/* --- Parche a setSending para idioma --- */
(function(){
  const submitBtn = document.getElementById('submitBtn');
  const btnText   = submitBtn?.querySelector('.btnText');
  const spinner   = submitBtn?.querySelector('.spinner');
  window.setSending = function(v){
    if (!submitBtn || !btnText || !spinner) return;
    submitBtn.disabled = v;
    spinner.style.display = v ? 'inline-block' : 'none';
    btnText.textContent = v ? t('btn_sending') : t('btn_send');
  };
})();

/* --- Helper para textos de modales en tu flujo --- */
function i18nModal(kind){
  const map = {
    recaptcha: {title: t('recaptcha_hint_title'), msg: t('recaptcha_hint_msg')},
    needSign:  {title: t('need_sign_title'),     msg: t('need_sign_msg')},
    sentOk:    {title: t('sent_ok_title'),       msg: t('sent_ok_msg')},
    sentFail:  {title: t('sent_fail_title')},
    netErr:    {title: t('error_net_title')}
  };
  return map[kind];
}

/* --- Cambiar título del modal de firma según quién firma --- */
window.setSigModalTitle = function(which){
  const el = document.getElementById('sigTitle');
  if (!el) return;
  el.textContent = (which==='cliente') ? t('fs_title_cli') : t('fs_title_staff');
};
</script>

<!-- ===== reCAPTCHA explícito (una vez por carga, idioma desde <head>) ===== -->
<script>
  const RECAPTCHA_SITEKEY = '6LcHCfIrAAAAAHZ9i6z-7WfL6O6CrmKeBMhytK-r';
  let recaptchaWidgetId = null;
  // Definida en el bloque principal para que api.js la encuentre
  window.recaptchaOnload = function(){
    recaptchaWidgetId = grecaptcha.render('recaptcha', { sitekey: RECAPTCHA_SITEKEY });
  };
</script>
</body>
</html>
