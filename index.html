<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="format-detection" content="telephone=no">
<title>Reserva de Carrito</title>
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --border:#e5e7eb; --text:#111827; --muted:#6b7280;
    --primary:#2563eb; --danger:#dc2626; --ok:#16a34a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  html{-webkit-text-size-adjust:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    font-size:16px;
  }
  @media (max-width:480px){ body{font-size:18px} }

  .wrap{max-width:920px;margin:0 auto;padding:clamp(12px,3.2vw,28px)}
  .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:clamp(14px,3.5vw,28px);box-shadow:0 6px 24px rgba(0,0,0,.06)}

  h2{margin:0 0 .5rem;font-size:clamp(1.25rem,4.8vw,1.8rem)}
  p.lead{margin:.25rem 0 1rem;color:var(--muted);font-size:clamp(1rem,3.8vw,1.05rem)}

  form{display:grid;gap:clamp(10px,3vw,18px)}
  label{font-weight:600;font-size:clamp(1rem,3.9vw,1.06rem);margin-bottom:6px;display:block}
  input,button{
    width:100%;padding:clamp(12px,3.4vw,14px);
    border:1px solid var(--border);border-radius:12px;font-size:clamp(1rem,3.8vw,1.06rem);
    background:#fff;
  }
  input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  .row{display:grid;gap:clamp(8px,2.8vw,12px)}
  .two{grid-template-columns:1fr 1fr;gap:clamp(8px,2.8vw,14px)}
  @media (max-width:760px){.two{grid-template-columns:1fr}}

  .sigRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .sigBtn{width:auto;background:var(--primary);color:#fff;border:none;font-weight:600;border-radius:10px;padding:10px 14px;cursor:pointer}
  .sigClear{width:auto;background:#fff;color:#111827;border:1px solid var(--border);border-radius:10px;padding:10px 14px}
  .thumb{width:160px;max-width:45vw;height:72px;border:1px solid var(--border);border-radius:8px;object-fit:contain;background:#fff;display:none}

  .btn{background:var(--primary);color:#fff;border:none;font-weight:600;cursor:pointer;display:inline-flex;gap:8px;align-items:center;justify-content:center}
  .btn[disabled]{opacity:.7;cursor:not-allowed}
  .spinner{width:1.1em;height:1.1em;border:2px solid rgba(255,255,255,.5);border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  .captchaBox{display:flex;justify-content:center}
  .footNote{color:var(--muted);font-size:.95rem;margin-top:.25rem}

  /* Modal mensajes */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);padding:16px;z-index:10000}
  .modal.show{display:flex}
  .modal .box{width:min(92vw,520px);background:#fff;border-radius:14px;padding:18px;border:1px solid var(--border);text-align:center}
  .modal h3{margin:.2rem 0 .6rem;font-size:1.15rem}
  .modal p{color:#374151;margin:.2rem 0 1rem}
  .modal .btn{min-width:160px}
  .modal .error{color:var(--danger)}
  .modal .ok{color:var(--ok)}

  /* Modal de firma full-screen */
  .sigModal{position:fixed;inset:0;background:#0f172a;display:none;flex-direction:column;z-index:11000}
  .sigModal.show{display:flex}
  .sigTop{color:#fff;display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.1)}
  .sigTopTitle{font-weight:700}
  .sigTop .btn, .sigTop .sigClear{padding:8px 12px;border-radius:10px}
  .sigCanvasFS{flex:1;background:#fff;touch-action:none}
  .bar{display:flex;gap:8px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Reserva de Carrito</h2>
      <p class="lead">Completá los datos y capturá la firma en pantalla completa.</p>

      <form id="f" autocomplete="off">
        <input name="empresa" autocomplete="off" style="position:absolute;left:-9999px;top:-9999px" tabindex="-1">
        <input type="hidden" name="t0" id="t0">
        <!-- donde guardamos los PNG en base64 -->
        <input type="hidden" name="firmaClienteDataURL" id="firmaClienteDataURL">
        <input type="hidden" name="firmaStaffDataURL"   id="firmaStaffDataURL">

        <div class="row"><label>Cliente/Visitante</label><input name="cliente" required placeholder="Nombre y apellido" inputmode="text"></div>

        <div class="row two">
          <div><label>DNI / Pasaporte</label><input name="dni" required inputmode="text"></div>
          <div><label>Teléfono de contacto</label><input name="telefono" required inputmode="tel" placeholder="+54 9 ..."></div>
        </div>

        <div class="row"><label>Domicilio</label><input name="domicilio" inputmode="text"></div>

        <div class="row two">
          <div><label>Fecha</label><input name="fecha" type="date" required></div>
          <div><label>Hora</label><input name="hora" type="time" required></div>
        </div>

        <div class="row"><label>Email del cliente (para enviar confirmación)</label><input name="emailCliente" type="email" placeholder="opcional" inputmode="email"></div>

        <!-- Firma Cliente -->
        <div class="row">
          <label>Firma del Cliente/Visitante</label>
          <div class="sigRow">
            <button type="button" class="sigBtn" id="openSigCliente">✍️ Firmar</button>
            <button type="button" class="sigClear" id="clearSigCliente">Borrar</button>
            <img id="thumbCliente" class="thumb" alt="Vista previa firma cliente">
          </div>
        </div>

        <!-- Datos Staff -->
        <div class="row">
          <label>Nombre y apellido del personal de Iguazú Argentina S.A.</label>
          <input name="staff" placeholder="opcional">
        </div>

        <!-- Firma Staff -->
        <div class="row">
          <label>Firma del personal de Iguazú Argentina S.A. (opcional)</label>
          <div class="sigRow">
            <button type="button" class="sigBtn" id="openSigStaff">✍️ Firmar</button>
            <button type="button" class="sigClear" id="clearSigStaff">Borrar</button>
            <img id="thumbStaff" class="thumb" alt="Vista previa firma staff">
          </div>
        </div>

        <div class="captchaBox"><div class="g-recaptcha" data-sitekey="6LcHCfIrAAAAAHZ9i6z-7WfL6O6CrmKeBMhytK-r"></div></div>

        <button id="submitBtn" class="btn" type="submit" style="padding:12px 18px;border-radius:12px">
          <span class="btnText">Enviar</span>
          <span class="spinner" style="display:none"></span>
        </button>
        <div class="footNote">Al enviar, aceptás el uso de tus datos para gestionar la reserva.</div>
      </form>
    </div>
  </div>

  <!-- Modal de firma (reutilizable para cliente/staff) -->
  <div id="sigModal" class="sigModal" aria-modal="true" role="dialog">
    <div class="sigTop">
      <div class="sigTopTitle" id="sigTitle">Firmar</div>
      <div class="bar">
        <button type="button" class="sigClear" id="sigClearBtn">Borrar</button>
        <button type="button" class="sigClear" id="sigCancelBtn">Cancelar</button>
        <button type="button" class="btn" id="sigUseBtn">Usar firma</button>
      </div>
    </div>
    <canvas id="sigCanvasFS" class="sigCanvasFS"></canvas>
  </div>

  <!-- Modal éxito / error -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="box">
      <h3 id="modalTitle">Mensaje</h3>
      <p id="modalMsg"></p>
      <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
        <button id="modalOk" class="btn" type="button">OK</button>
        <button id="modalRetry" class="sigClear" type="button" style="display:none">Reintentar</button>
      </div>
    </div>
  </div>

<script>
  /* ===== CONFIG ===== */
  const APPS_URL = 'https://script.google.com/macros/s/AKfycbwSlAExsi5mF3Zgr-N3nB9QcrAaW8TktcSr-ZhOaoXGEfo8l6SsW5K8fQ5Wqp3Yhuv2/exec';
  document.getElementById('t0').value = Date.now();

  /* ===== MODAL MENSAJES ===== */
  const modal=document.getElementById('modal'),modalTitle=document.getElementById('modalTitle'),modalMsg=document.getElementById('modalMsg'),modalOk=document.getElementById('modalOk'),modalRetry=document.getElementById('modalRetry');
  function showModal({title,msg,isError=false,onOk=null,showRetry=false,onRetry=null}){modalTitle.textContent=title||(isError?'Error':'Información');modalMsg.innerHTML=msg||'';modal.classList.add('show');modalMsg.classList.toggle('error',isError);modalMsg.classList.toggle('ok',!isError);modalRetry.style.display=showRetry?'inline-block':'none';modalOk.onclick=()=>{modal.classList.remove('show');onOk&&onOk();};modalRetry.onclick=()=>{modal.classList.remove('show');onRetry&&onRetry();};}

  /* ===== MODAL FIRMA FULL-SCREEN ===== */
  const sigModal = document.getElementById('sigModal');
  const sigCanvas = document.getElementById('sigCanvasFS');
  const sigTitle  = document.getElementById('sigTitle');
  const sigClearBtn  = document.getElementById('sigClearBtn');
  const sigCancelBtn = document.getElementById('sigCancelBtn');
  const sigUseBtn    = document.getElementById('sigUseBtn');

  let currentTarget = null; // 'cliente' | 'staff'

  // Abrir modal
  document.getElementById('openSigCliente').onclick = ()=> openSig('cliente');
  document.getElementById('openSigStaff').onclick   = ()=> openSig('staff');

  // Borrar desde fuera
  document.getElementById('clearSigCliente').onclick = ()=> clearSaved('cliente');
  document.getElementById('clearSigStaff').onclick   = ()=> clearSaved('staff');

  function openSig(which){
    currentTarget = which;
    sigTitle.textContent = which === 'cliente' ? 'Firma del Cliente/Visitante' : 'Firma del personal (opcional)';
    sigModal.classList.add('show');
    resetSigCanvas(); // limpia y ajusta tamaño
  }

  function closeSig(){
    sigModal.classList.remove('show');
  }

  function clearSaved(which){
    const input = document.getElementById(which==='cliente' ? 'firmaClienteDataURL' : 'firmaStaffDataURL');
    const thumb = document.getElementById(which==='cliente' ? 'thumbCliente' : 'thumbStaff');
    input.value = '';
    thumb.style.display = 'none';
    thumb.src = '';
  }

  // Canvas de firma FS (retina + dibujo)
  const ctx = sigCanvas.getContext('2d');
  function resetSigCanvas(){
    const ratio = Math.max(window.devicePixelRatio||1,1);
    // ocupar casi toda la pantalla disponible
    const dw = window.innerWidth;
    const dh = window.innerHeight - 56; // resta barra superior
    sigCanvas.style.width = dw + 'px';
    sigCanvas.style.height= dh + 'px';
    sigCanvas.width  = Math.floor(dw*ratio);
    sigCanvas.height = Math.floor(dh*ratio);
    ctx.setTransform(ratio,0,0,ratio,0,0);
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,sigCanvas.width, sigCanvas.height);
    ctx.lineWidth = 2.8; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#111';
  }
  window.addEventListener('resize', ()=>{ if(sigModal.classList.contains('show')) resetSigCanvas(); });

  let drawing=false,last=null;
  function pos(e){const r=sigCanvas.getBoundingClientRect();const t=e.touches?e.touches[0]:e;return {x:t.clientX-r.left,y:t.clientY-r.top};}
  function start(e){drawing=true;last=pos(e);e.preventDefault();}
  function move(e){if(!drawing)return;const p=pos(e);ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p;e.preventDefault();}
  function end(){drawing=false;last=null;}

  sigCanvas.addEventListener('mousedown',start);
  sigCanvas.addEventListener('mousemove',move);
  sigCanvas.addEventListener('mouseup',end);
  sigCanvas.addEventListener('mouseleave',end);
  sigCanvas.addEventListener('touchstart',start,{passive:false});
  sigCanvas.addEventListener('touchmove',move,{passive:false});
  sigCanvas.addEventListener('touchend',end);

  sigClearBtn.onclick = ()=> ctx.clearRect(0,0,sigCanvas.width,sigCanvas.height), resetSigCanvas();
  sigCancelBtn.onclick= ()=> closeSig();
  sigUseBtn.onclick   = ()=> {
    const dataURL = sigCanvas.toDataURL('image/png');
    const input = document.getElementById(currentTarget==='cliente' ? 'firmaClienteDataURL' : 'firmaStaffDataURL');
    const thumb = document.getElementById(currentTarget==='cliente' ? 'thumbCliente' : 'thumbStaff');
    input.value = dataURL;
    thumb.src = dataURL;
    thumb.style.display = 'block';
    closeSig();
  };

  /* ===== ENVÍO ===== */
  const form=document.getElementById('f'),submitBtn=document.getElementById('submitBtn'),btnText=submitBtn.querySelector('.btnText'),spinner=submitBtn.querySelector('.spinner');
  function setSending(v){submitBtn.disabled=v;spinner.style.display=v?'inline-block':'none';btnText.textContent=v?'Enviando…':'Enviar';}

  function isBlankDataURL(s){return !s || s.length < 50;} // heurística simple

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (submitBtn.disabled) return;

    const recaptchaToken = grecaptcha.getResponse();
    if (!recaptchaToken){ showModal({title:'Falta verificación', msg:'Marcá <b>No soy un robot</b>.'}); return; }

    // Exigir firma de cliente
    if (isBlankDataURL(document.getElementById('firmaClienteDataURL').value)){
      showModal({title:'Falta firma', msg:'Necesitamos la firma del cliente (botón ✍️ Firmar).'}); return;
    }

    const fd = new FormData(form);
    const payload = Object.fromEntries(fd.entries());
    payload.recaptchaToken = recaptchaToken;

    setSending(true);
    try{
      const res = await fetch(APPS_URL, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });
      const json = await res.json().catch(()=>({ok:false,error:'Respuesta inválida'}));
      setSending(false); grecaptcha.reset();

      if (json.ok){
        showModal({title:'¡Enviado correctamente!', msg:'Tu reserva fue registrada y se envió la confirmación por correo.', onOk: ()=>location.reload()});
      } else {
        showModal({title:'No se pudo enviar', msg:`<span class="error">${json.error||'Error desconocido'}</span>`, isError:true, showRetry:true, onRetry: ()=>form.dispatchEvent(new Event('submit',{cancelable:true}))});
      }
    } catch(err){
      setSending(false); grecaptcha.reset();
      showModal({title:'Error de red', msg:`<span class="error">${String(err)}</span>`, isError:true, showRetry:true, onRetry: ()=>form.dispatchEvent(new Event('submit',{cancelable:true}))});
    }
  });
</script>
</body>
</html>
